<?xml version="1.0" encoding="utf-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
   <map:components>
      <map:generators default="file" >
         <map:generator name="commandGenerator" src="org.xmlqstat.generator.CommandGenerator">
            <expire>60</expire> 
         </map:generator>   
      </map:generators>   
      <map:transformers default="xslt" />
      <map:readers default="resource" />
      <map:serializers default="xhtml">
         
         <!-- Our custom XHTML output serializer for Sony PSP browsers -->
         <map:serializer
            name="xhtml-psp"
            src="org.apache.cocoon.serialization.XMLSerializer"
            mime-type="text/html; charset=ISO-8859-1">
            <omit-xml-declaration>yes</omit-xml-declaration>
            <omit-namespaces>yes</omit-namespaces>
            <encoding>UTF-8</encoding>
            <doctype-public>-//W3C//DTD XHTML 1.0 Strict//EN</doctype-public>
            <doctype-system>http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd</doctype-system>
         </map:serializer>
         
         
         <!-- ATOM 1.0 Feed Serialzer -->
         <map:serializer
            name="atom-xml"
            src="org.apache.cocoon.serialization.XMLSerializer"
            mime-type="application/atom+xml; charset=UTF-8">
            <encoding>UTF-8</encoding>
         </map:serializer>
         
      </map:serializers>
      
      <map:selectors default="browser">
         <!-- Need to auto-detect MS and PSP browers -->
         <map:selector name="browser"
                       src="org.apache.cocoon.selection.BrowserSelector">
            <browser name="explorer" useragent="MSIE"/>
            <browser name="sonyPSP"  useragent="PlayStation Portable"/>
         </map:selector>
      </map:selectors>
      
      <map:matchers default="wildcard" />
   </map:components>
   <map:pipelines>
      
      <map:pipeline>
         
         <!-- Catch & redirect people going to http://<server>/xmlqstat/  -->
         <map:match pattern="">
            <map:redirect-to uri="qstat.html"/>
         </map:match>
         
         <!-- intercept unsupported browsers and SonyPSP user-agents -->
         <map:match pattern="*">
            <map:select type="browser">
               <map:when test="explorer">
                  <map:redirect-to uri="info/unsupported.html"/>
               </map:when>
               <map:otherwise>
                  <!-- do nothing, continue flow -->
               </map:otherwise>
            </map:select>
         </map:match>
         
         <!-- This lets cocoon find our static files -->
         <map:match pattern="css/*.css">
            <map:read mime-type="text/css" src="css/{1}.css" />
         </map:match>
         <map:match pattern="javascript/*.js">
            <map:read mime-type="text/javascript" src="javascript/{1}.js" />
         </map:match>
         <map:match pattern="images/*.gif">
            <map:read mime-type="image/gif" src="images/{1}.gif" />
         </map:match>
         <map:match pattern="images/icons/*/**.png">
            <map:read mime-type="image/png" src="images/icons/{1}/{2}.png" />
         </map:match>
         <map:match pattern="images/screencap/*.**">
            <map:read mime-type="image/{2}" src="images/screencap/{1}.{2}" />
         </map:match>
         
         <!-- documentation rendering for url path /info/ -->
         <map:match pattern="info/*.html">
            <map:generate src="xml/info/{1}.xml" />
            <map:transform src="xsl/info-to-xhtml.xsl">
               <map:parameter name="timestamp" value="{date:EEE, d MMM yyyy HH:mm:ss}"/>
            </map:transform>
            <map:serialize type="xhtml" />
         </map:match>
         
         <!-- MOBILE PSP rendering for url path /psp/ -->
         <map:match pattern="psp/*.html">
            <map:generate type="commandGenerator" src="qstat -xml -r -f -explain aAcE" />
            <map:transform src="xsl/qstat-to-psp.xsl">
               <map:parameter name="timestamp" value="{date:EEE, d MMM yyyy HH:mm:ss}"/>
               <map:parameter name="renderMode" value="{1}"/>
            </map:transform>
            <map:serialize type="xhtml-psp"/>
         </map:match>
         
         
         <!-- time example: 1985-04-12T23:20:50.52Z -->

         <!-- ATOM XML FEED -->
         <map:match pattern="feed/*">
            <map:generate type="commandGenerator" src="qstat -xml -r -f -explain aAcE" />
            <map:transform src="xsl/feed-atom-{1}.xsl">
               <map:parameter name="timestamp1" value="{date:yyyy-MM-DD}"/>
               <map:parameter name="timestamp2" value="{date:HH:mm:ss}"/>
            </map:transform>
            <map:serialize type="atom-xml" />
         </map:match>
         
         <!-- SGE JOB rendering for url path /job/  -->
         <map:match pattern="job/*.html">
            <map:generate type="commandGenerator" src="qstat -f -F -xml -j {1}" />
            <map:transform src="xsl/job-to-xhtml.xsl">
               <map:parameter name="jobID" value="{1}" />
               <map:parameter name="timestamp" value="{date:EEE, d MMM yyyy HH:mm:ss}"/>
            </map:transform>
            <map:serialize type="xhtml" />
         </map:match>
         
         
         <!-- Standard View; CACHED Grid Engine XML data -->
         <!-- URL will be "/xmlqstat/qstat.html"        -->
         <map:match pattern="qstat.html">
            <map:generate type="commandGenerator" src="qstat -xml -r -f -explain aAcE" />
            <map:transform src="xsl/qstat-xhtmlCSS-standard-v2.xsl">
               <map:parameter name="showQtable"  value="{cookie:displayQtable}" />
               <map:parameter name="showPJtable" value="{cookie:displayPJtable}" />
               <map:parameter name="showAJtable" value="{cookie:displayAJtable}" />
               <map:parameter name="enableResourceQueries" value="no" />
               <map:parameter name="real" value="yes" />
               <map:parameter name="perUserJobSort" value="no" />
               <map:parameter name="timestamp" value="{date:EEE, d MMM yyyy HH:mm:ss}"/>
               
            </map:transform>
            <map:serialize type="xhtml" />
         </map:match>
         
         
         <!-- JOBS SHOWN PER USER -->
         <!-- URL will be "/xmlqstat/(user)-jobs.html"        -->
         <map:match pattern="*-jobs.html">
            <map:generate type="commandGenerator" src="qstat -xml -r -f -explain aAcE" />
            <map:transform src="xsl/qstat-xhtmlCSS-standard-v2.xsl">
               <map:parameter name="showQtable" value="yes" />
               <map:parameter name="showPJtable" value="{cookie:displayPJtable}" />
               <map:parameter name="showAJtable" value="{cookie:displayAJtable}" />
               <map:parameter name="enableResourceQueries" value="no" />
               <map:parameter name="real" value="yes" />
               <map:parameter name="perUserJobSort" value="{1}" />
               <map:parameter name="timestamp" value="{date:EEE, d MMM yyyy HH:mm:ss}"/>
            </map:transform>
            <map:serialize type="xhtml" />
         </map:match>
         
         <!-- Terse View; CACHED Grid Engine XML data -->
         <!-- URL will be "/xmlqstat/qstat-terse.html"        -->
         <map:match pattern="qstat-terse.html">
            <map:generate type="commandGenerator" src="qstat -xml -r -f -explain aAcE" />
            <map:transform src="xsl/qstat-xhtmlCSS-terse-v2.xsl">
               <map:parameter name="showQtable" value="yes" />
               <map:parameter name="real" value="yes" />
               <map:parameter name="perUserJobSort" value="no" />
               <map:parameter name="timestamp" value="{date:EEE, d MMM yyyy HH:mm:ss}"/>
               
            </map:transform>
            <map:serialize type="xhtml" />
         </map:match>
      </map:pipeline>
   </map:pipelines>
</map:sitemap>
